-- ================= SERVICES =================
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")

local lp = Players.LocalPlayer
local SPEED = 320

-- ================= GET GAP PART =================
local function getGapPart(gap)
	if not gap then return nil end
	if gap.Name == "Gap6" then
		local mud = gap:FindFirstChild("Mud")
		if mud and mud:IsA("BasePart") then
			return mud
		end
	end

	local children = gap:GetChildren()
	if children[2] and children[2]:IsA("BasePart") then
		return children[2]
	end

	return nil
end

-- ================= FIND CURRENT / NEXT / PREV GAP =================
local function getCurrentNextPrevGap()
	local char = lp.Character or lp.CharacterAdded:Wait()
	local hrp = char:WaitForChild("HumanoidRootPart")

	local gapsFolder = workspace.Misc and workspace.Misc:FindFirstChild("Gaps")
	if not gapsFolder then return end

	local nearestIndex
	local nearestDist = math.huge

	for _, gap in ipairs(gapsFolder:GetChildren()) do
		if gap:IsA("Model") then
			local part = getGapPart(gap)
			if part then
				local dist = (part.Position - hrp.Position).Magnitude
				if dist < nearestDist then
					nearestDist = dist
					nearestIndex = tonumber(gap.Name:match("%d+"))
				end
			end
		end
	end

	if not nearestIndex then return end

	return
		gapsFolder:FindFirstChild("Gap" .. nearestIndex),
		gapsFolder:FindFirstChild("Gap" .. (nearestIndex + 1)),
		gapsFolder:FindFirstChild("Gap" .. (nearestIndex - 1))
end

-- ================= MOVE TO GAP =================
local function moveToGap(gap)
	if not gap then return end

	local char = lp.Character or lp.CharacterAdded:Wait()
	local hrp = char:WaitForChild("HumanoidRootPart")

	local part = getGapPart(gap)
	if not part then return end

	local params = RaycastParams.new()
	params.FilterDescendantsInstances = {char}
	params.FilterType = Enum.RaycastFilterType.Blacklist

	local result = workspace:Raycast(
		part.Position + Vector3.new(0, 10, 0),
		Vector3.new(0, -60, 0),
		params
	)

	local targetPos = result and (result.Position + Vector3.new(0, 2.5, 0))
		or (part.Position + Vector3.new(0, 2.5, 0))

	local dist = (hrp.Position - targetPos).Magnitude
	local t = dist / SPEED

	TweenService:Create(
		hrp,
		TweenInfo.new(t, Enum.EasingStyle.Linear),
		{CFrame = CFrame.new(targetPos)}
	):Play()
end

-- ================= UI =================
local gui = Instance.new("ScreenGui")
gui.Name = "GapUI"
gui.ResetOnSpawn = false
gui.Parent = lp:WaitForChild("PlayerGui")

local frame = Instance.new("Frame", gui)
frame.Size = UDim2.fromOffset(220, 140)
frame.Position = UDim2.fromScale(0.02, 0.4)
frame.BackgroundColor3 = Color3.fromRGB(70, 150, 255) -- ฟ้า
frame.BorderSizePixel = 0
Instance.new("UICorner", frame).CornerRadius = UDim.new(0,12)

-- ================= DRAG UI (ชัวร์) =================
local dragging = false
local dragStart
local startPos

local function beginDrag(input)
	dragging = true
	dragStart = input.Position
	startPos = frame.Position

	input.Changed:Connect(function()
		if input.UserInputState == Enum.UserInputState.End then
			dragging = false
		end
	end)
end

frame.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1
	or input.UserInputType == Enum.UserInputType.Touch then
		beginDrag(input)
	end
end)

UserInputService.InputChanged:Connect(function(input)
	if dragging and (
		input.UserInputType == Enum.UserInputType.MouseMovement
		or input.UserInputType == Enum.UserInputType.Touch
	) then
		local delta = input.Position - dragStart
		frame.Position = UDim2.new(
			startPos.X.Scale,
			startPos.X.Offset + delta.X,
			startPos.Y.Scale,
			startPos.Y.Offset + delta.Y
		)
	end
end)

-- ================= TITLE =================
local title = Instance.new("TextLabel", frame)
title.Size = UDim2.new(1,0,0,32)
title.BackgroundTransparency = 1
title.Text = "Gap Controller"
title.TextColor3 = Color3.new(1,1,1)
title.Font = Enum.Font.GothamBold
title.TextSize = 15
title.Active = true -- สำคัญมากสำหรับลาก
title.InputBegan:Connect(beginDrag)

-- ================= BUTTON =================
local function makeBtn(text, pos, callback)
	local b = Instance.new("TextButton", frame)
	b.Size = UDim2.new(0.9,0,0,35)
	b.Position = pos
	b.BackgroundColor3 = Color3.fromRGB(255, 210, 80) -- เหลือง
	b.Text = text
	b.TextColor3 = Color3.fromRGB(40,40,40)
	b.Font = Enum.Font.GothamBold
	b.TextSize = 14
	b.BorderSizePixel = 0
	Instance.new("UICorner", b).CornerRadius = UDim.new(0,8)
	b.MouseButton1Click:Connect(callback)
end

-- ⬆ Up
makeBtn("⬆ Up (Next Gap)", UDim2.new(0.05,0,0.35,0), function()
	local _, nextGap = getCurrentNextPrevGap()
	moveToGap(nextGap)
end)

-- ⬇ Down
makeBtn("⬇ Down (Prev Gap)", UDim2.new(0.05,0,0.65,0), function()
	local _, _, prevGap = getCurrentNextPrevGap()
	moveToGap(prevGap)
end)
